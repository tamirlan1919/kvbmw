{% extends 'base.html' %}

{% block title %}Розыгрыш PORSCHE CAYENNE - Регистрация{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Информация о призе -->
    <div class="col-lg-6">
        <div class="prize-card p-3">
            <div class="car-image-container position-relative mb-4">
                <img src="{{ url_for('static', filename='images/image.png') }}?v=1" alt="Porsche Cayenne" class="car-image w-100">
            </div>
            <h3 class="feature-heading mb-4"><i class="fas fa-info-circle me-2"></i>Для участия в розыгрыше необходимо:</h3>
            <div class="car-specs mb-4">
                <div class="row g-3">
                    <div class="col-12 mb-3">
                        <div class="spec-card d-flex border border-dark" style="overflow: hidden; max-width: 600px; margin: 0 auto;">
                            <div class="number-badge bg-black text-white d-flex align-items-center justify-content-center" style="min-width: 80px; width: 80px; font-weight: bold; font-size: 2.5rem;">1</div>
                            <div class="bg-white text-left flex-grow-1 d-flex flex-column justify-content-center p-3 py-4" style="min-height: 100px;">
                                <h5 class="mb-1 text-dark" style="font-size: 1.5rem; font-weight: 700; line-height: 1.3;">Вступить в сообщество</h5>
                                <p class="mb-0 text-dark" style="font-size: 1.3rem;">«PORSCHE от КАМИЛЯ»</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="spec-card d-flex border border-dark" style="overflow: hidden; max-width: 600px; margin: 0 auto;">
                            <div class="number-badge bg-black text-white d-flex align-items-center justify-content-center" style="min-width: 80px; width: 80px; font-weight: bold; font-size: 2.5rem;">2</div>
                            <div class="bg-white text-left flex-grow-1 d-flex flex-column justify-content-center p-3 py-4" style="min-height: 100px;">
                                <h5 class="mb-1 text-dark" style="font-size: 1.5rem; font-weight: 700; line-height: 1.3;">Добавить всего 30 спонсоров</h5>
                                <p class="mb-0 text-dark" style="font-size: 1.3rem;">отправим в сообщество</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="spec-card d-flex border border-dark" style="overflow: hidden; max-width: 600px; margin: 0 auto;">
                            <div class="number-badge bg-black text-white d-flex align-items-center justify-content-center" style="min-width: 80px; width: 80px; font-weight: bold; font-size: 2.5rem;">3</div>
                            <div class="bg-white text-left flex-grow-1 d-flex flex-column justify-content-center p-3 py-4" style="min-height: 100px;">
                                <h5 class="mb-1 text-dark" style="font-size: 1.5rem; font-weight: 700; line-height: 1.3;">Выложить на статус видео с ссылкой</h5>
                                <p class="mb-0 text-dark" style="font-size: 1.3rem;">отправим в сообщество</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="rules-heading"><i class="fas fa-gavel me-2"></i>Правила розыгрыша</h3>
            <ul class="rules-list">
                <li>Участвовать могут только жители Хасаюртовского, Кизлярского или Бабаюртовского районов</li>
                <li>Возраст участников должен быть не менее 16 лет</li>
                <li>Нельзя покидать сообщество до завершения розыгрыша</li>
                <li>Победитель будет выбран случайным образом</li>
            </ul>
        </div>
    </div>
    
    <!-- Форма регистрации -->
    <div class="col-lg-6">
        <div class="registration-card p-4">
            <h2 class="text-center mb-4"><i class="fas fa-user-plus me-2 text-primary"></i>Регистрация участника</h2>
            
            <div id="location-status" style="display: none;"></div>
            
            <form id="registration-form" action="/" method="post" class="registration-form">
                {{ form.hidden_tag() }}
                <input type="hidden" id="latitude" name="latitude" value="">
                <input type="hidden" id="longitude" name="longitude" value="">

                <!-- Фамилия и Имя -->
                <div class="form-group mb-3">
                    <label for="full_name" class="form-label"><i class="fas fa-user me-2"></i>Фамилия и Имя:</label>
                    <input type="text" class="form-control" id="full_name" name="full_name" required>
                </div>

                <!-- Номер телефона -->
                <div class="form-group mb-3">
                    <div class="text-danger fw-bold mb-2"><i class="fab fa-whatsapp me-2"></i>Номер должен быть зарегистрирован в WhatsApp</div>
                    <label for="phone" class="form-label"><i class="fas fa-phone-alt me-2"></i>Номер телефона:</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+7 (999) 999-99-99" required>
                </div>

                <!-- Возраст -->
                <div class="form-group mb-3">
                    <label for="age" class="form-label"><i class="fas fa-birthday-cake me-2"></i>Возраст:</label>
                    <input type="number" class="form-control" id="age" name="age" min="16" max="100" required>
                </div>

                <!-- Пол -->
                <div class="form-group mb-4">
                    <label class="form-label d-block"><i class="fas fa-venus-mars me-2"></i>Пол:</label>
                    <div class="gender-options d-flex">
                        <div class="form-check form-check-inline me-4">
                            <input class="form-check-input" type="radio" name="gender" id="male" value="male" required>
                            <label class="form-check-label" for="male">Мужской</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="female" value="female">
                            <label class="form-check-label" for="female">Женский</label>
                        </div>
                    </div>
                </div>

                <!-- После поля "Пол" добавьте: -->
                <div class="form-group mb-4">
                    <label for="district" class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Район проживания:</label>
                    {{ form.district(class="form-select") }}
                </div>

                <!-- Кнопка отправки формы -->
                <button type="submit" id="submit-registration" class="btn btn-register btn-lg w-100">
                    <i class="fas fa-check-circle me-2"></i>Участвовать в розыгрыше
                </button>
            </form>
                  <!-- Ссылка на предыдущие розыгрыши -->
                  <div class="previous-contests mt-4">
                    <div class="p-3 bg-dark rounded text-center">
                        <h3 class="mb-3"><i class="fab fa-vk text-primary me-2"></i>Прошлые розыгрыши</h3>
                        <p>Посмотрите результаты прошлых розыгрышей и истории победителей в нашей группе ВКонтакте</p>
                        <a href="https://vk.com/clips/playlist/788943776_1" target="_blank" class="btn btn-primary mt-2">
                            <i class="fab fa-vk me-2"></i>Перейти в группу ВКонтакте
                        </a>
                    </div>
                </div>

                <div class="previous-contests mt-4">
                    <div class="p-3 bg-dark rounded text-center">
                        <h3 class="mb-3"><i class="fab fa-vk text-primary me-2"></i>ИТОГИ РОЗЫГРЫША</h3>
                        <p>Будут опубликованы на странице ВКонтакте</p>
                        <a href="https://vk.com/kamil_vagidov" target="_blank" class="btn btn-primary mt-2">
                            <i class="fab fa-vk me-2"></i>СТРАНИЦА КАМИЛЯ ВАГИДОВА
                        </a>
                    </div>
                </div>
        </div>
    </div>
</div>


<!-- Модальное окно для успешной регистрации -->
<div class="modal fade" id="registrationSuccessModal"  tabindex="-1" aria-labelledby="registrationSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style = "color: black; background-color:white;" >
            <div class="modal-header">
                <h5 class="modal-title" id="registrationSuccessModalLabel">Поздравляем!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы успешно зарегистрировались на розыгрыш от Камиля Вагидова!</p>
                <p>Ваш НОМЕРОК для участия - это ваш НОМЕР ТЕЛЕФОНА</p>
                <button class="btn btn-primary"><a style="color: black;" href="https://chat.whatsapp.com/">Перейти в сообщество</a></button>
                <p id="countdown">Вы будете перенаправлены через 5 секунд...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для уже зарегистрированного номера -->
<div class="modal fade" id="alreadyRegisteredModal" tabindex="-1" aria-labelledby="alreadyRegisteredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style = "color: black; background-color:white;" >
            <div class="modal-header">
                <h5 class="modal-title" id="alreadyRegisteredModalLabel">Ваш номер уже зарегистрирован</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ваш номер телефона уже зарегистрирован в системе</p>
                <p>Ваш НОМЕРОК для участия - это ваш НОМЕР ТЕЛЕФОНА</p>
                <button class="btn btn-primary"><a style="color: black;" href="https://chat.whatsapp.com/">Перейти в сообщество</a></button>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% if is_registered is not none %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('is_registered:', '{{ is_registered }}'); // Отладка
            var modalId = '{{ is_registered }}';
            var modalElement = document.querySelector(modalId);
            if (modalElement) {
                var modal = new bootstrap.Modal(modalElement);
                modal.show();

                if (modalId === '#registrationSuccessModal') {
                    var countdownElement = document.getElementById('countdown');
                    var seconds = 5;
                    var countdown = setInterval(function() {
                        seconds--;
                        countdownElement.textContent = `Вы будете перенаправлены через ${seconds} секунд...`;
                        if (seconds <= 0) {
                            clearInterval(countdown);
                            window.location.href = "https://chat.whatsapp.com/";
                        }
                    }, 1000);
                }
            } else {
                console.error('Модальное окно не найдено:', modalId);
            }
        });
    </script>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.7/dist/inputmask.min.js"></script>
<script>
    var phoneMask = new Inputmask('+7 (999) 999-99-99');
    phoneMask.mask(document.getElementById('phone'));

    let locationFetched = false;
    let lastPosition = null;
    
    function getLocation(callback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    console.log('Геолокация обновлена:', {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                    locationFetched = true;
                    lastPosition = position;
                    if (callback) callback(true);
                },
                function(error) {
                    document.getElementById('location-status').style.display = 'block';
                    let errorMessage;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Доступ к геолокации запрещён. Разрешите доступ в настройках.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Местоположение недоступно. Проверьте GPS или интернет.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Время ожидания истекло. Попробуйте снова.";
                            break;
                        default:
                            errorMessage = "Неизвестная ошибка геолокации.";
                    }
                    document.getElementById('location-status').innerText = errorMessage;
                    if (callback) callback(false);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            alert('Геолокация не поддерживается этим браузером.');
            if (callback) callback(false);
        }
    }
    
    document.getElementById('registration-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (locationFetched && lastPosition) {
            // Используем уже полученные координаты
            document.getElementById('latitude').value = lastPosition.coords.latitude;
            document.getElementById('longitude').value = lastPosition.coords.longitude;
            document.getElementById('registration-form').submit();
        } else {
            // Запрашиваем геолокацию
            getLocation(function(success) {
                if (success) {
                    document.getElementById('registration-form').submit();
                } else {
                    // Ошибка уже отображена в location-status
                }
            });
        }
    });
</script>
{% endblock %}
